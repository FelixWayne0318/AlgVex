name: Test Failure Analysis

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

concurrency:
  group: test-analysis-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

permissions:
  contents: read
  actions: write
  id-token: write

jobs:
  detect-flaky:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    # 添加 outputs 供 ci-failure-auto-fix 工作流使用
    outputs:
      is_flaky: ${{ steps.validate.outputs.is_flaky }}
      should_auto_fix: ${{ steps.set_result.outputs.should_auto_fix }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Detect flaky test failures
        id: detect
        uses: anthropics/claude-code-action@v1
        continue-on-error: true
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            The CI workflow failed: ${{ github.event.workflow_run.html_url }}

            Check the logs: gh run view ${{ github.event.workflow_run.id }} --log-failed

            Determine if this looks like a flaky test failure by checking for:
            - Timeout errors
            - Race conditions
            - Network errors
            - "Expected X but got Y" intermittent failures
            - Tests that passed in previous commits

            Return:
            - is_flaky: true if likely flaky, false if real bug
            - confidence: number 0-1 indicating confidence level
            - summary: brief one-sentence explanation
          claude_args: |
            --model claude-opus-4-5-20251101
            --max-turns 10
            --allowedTools "Bash(gh run:*),Bash(gh api:*)"
            --json-schema '{"type":"object","properties":{"is_flaky":{"type":"boolean","description":"Whether this appears to be a flaky test failure"},"confidence":{"type":"number","minimum":0,"maximum":1,"description":"Confidence level in the determination"},"summary":{"type":"string","description":"One-sentence explanation of the failure"}},"required":["is_flaky","confidence","summary"]}'

      - name: Validate detection output
        id: validate
        env:
          DETECT_OUTCOME: ${{ steps.detect.outcome }}
          STRUCTURED_OUTPUT: ${{ steps.detect.outputs.structured_output }}
        run: |
          if [ "$DETECT_OUTCOME" != "success" ] || [ -z "$STRUCTURED_OUTPUT" ]; then
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "::warning::Detection step failed or returned empty output"
            exit 0
          fi

          OUTPUT="$STRUCTURED_OUTPUT"

          # Validate JSON format
          if ! echo "$OUTPUT" | jq -e . >/dev/null 2>&1; then
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "::warning::Invalid JSON output from detection step"
            exit 0
          fi

          # Check if required field exists (using has() to avoid boolean false issue)
          if ! echo "$OUTPUT" | jq -e 'has("is_flaky")' >/dev/null 2>&1; then
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "::warning::Missing is_flaky field in output"
            exit 0
          fi

          # Extract fields (don't use // for boolean values to avoid false being treated as null)
          IS_FLAKY=$(echo "$OUTPUT" | jq -r '.is_flaky')
          CONFIDENCE=$(echo "$OUTPUT" | jq -r '.confidence // 0')
          SUMMARY=$(echo "$OUTPUT" | jq -r '.summary // "No summary available"')

          echo "valid=true" >> $GITHUB_OUTPUT
          echo "is_flaky=$IS_FLAKY" >> $GITHUB_OUTPUT
          echo "confidence=$CONFIDENCE" >> $GITHUB_OUTPUT
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
          echo "✅ 解析成功: is_flaky=$IS_FLAKY, confidence=$CONFIDENCE"

      - name: Retry flaky tests
        if: |
          steps.validate.outputs.valid == 'true' &&
          steps.validate.outputs.is_flaky == 'true' &&
          fromJSON(steps.validate.outputs.confidence) >= 0.7
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Flaky test detected (confidence: ${{ steps.validate.outputs.confidence }})"
          echo "Summary: ${{ steps.validate.outputs.summary }}"
          echo ""
          echo "Triggering automatic retry..."

          gh workflow run "${{ github.event.workflow_run.name }}" \
            --ref "${{ github.event.workflow_run.head_branch }}"

      - name: Comment on PR
        if: |
          github.event.workflow_run.event == 'pull_request' &&
          steps.validate.outputs.valid == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          IS_FLAKY: ${{ steps.validate.outputs.is_flaky }}
          CONFIDENCE: ${{ steps.validate.outputs.confidence }}
          SUMMARY: ${{ steps.validate.outputs.summary }}
          WORKFLOW_URL: ${{ github.event.workflow_run.html_url }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          pr_number=$(gh pr list --head "$HEAD_BRANCH" --json number --jq '.[0].number')

          if [ -n "$pr_number" ]; then
            if [ "$IS_FLAKY" = "true" ]; then
              TITLE="Flaky Test Detected"
              ACTION="Automatically retrying the workflow"
            else
              TITLE="Test Failure"
              ACTION="This appears to be a real bug - manual intervention needed"
            fi

            gh pr comment "$pr_number" --body "## $TITLE

**Analysis**: $SUMMARY
**Confidence**: $CONFIDENCE

$ACTION

[View workflow run]($WORKFLOW_URL)"
          fi

      - name: Set analysis result
        id: set_result
        if: steps.validate.outputs.valid == 'true'
        env:
          IS_FLAKY: ${{ steps.validate.outputs.is_flaky }}
        run: |
          # 只有当不是 flaky test 时才应该自动修复
          if [ "$IS_FLAKY" == "false" ]; then
            echo "should_auto_fix=true" >> $GITHUB_OUTPUT
            echo "✅ 不是 flaky test，建议自动修复"
          else
            echo "should_auto_fix=false" >> $GITHUB_OUTPUT
            echo "⚠️ 检测到 flaky test，已触发重试，不需要自动修复"
          fi
