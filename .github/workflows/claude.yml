name: Claude (GitHub App) + Slack Notify

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  claude:
    if: contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Claude Code Action (GitHub App)
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: "@claude"
          label_trigger: "claude"
          branch_prefix: "claude/"
          github_token: ${{ github.token }}

      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ACTOR: ${{ github.actor }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL missing"; exit 0
          fi

          curl -sS -X POST -H 'Content-type: application/json' \
          --data "{\"text\": \"Claude job finished âœ…\\nRepo: ${REPO}\\nActor: ${ACTOR}\\nRun: ${RUN_URL}\\nIssue/PR: ${ISSUE_URL}\"}" \
          "$SLACK_WEBHOOK_URL" || true
